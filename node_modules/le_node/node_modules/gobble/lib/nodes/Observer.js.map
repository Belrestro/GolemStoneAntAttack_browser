{"version":3,"file":"Observer.js","sources":["../../../../src/nodes/Observer.js"],"sourcesContent":["import * as sander from 'sander';\nimport Node from './Node';\nimport queue from '../queue';\nimport GobbleError from '../utils/GobbleError';\nimport assign from '../utils/assign';\nimport uid from '../utils/uid';\nimport makeLog from '../utils/makeLog';\nimport config from '../config';\nimport extractLocationInfo from '../utils/extractLocationInfo';\nimport { ABORTED } from '../utils/signals';\n\nexport default class Observer extends Node {\n\tconstructor ( input, fn, options, id ) {\n\t\tsuper();\n\n\t\tthis.input = input;\n\n\t\tthis.fn = fn;\n\t\tthis.options = assign( {}, options );\n\n\t\tthis.name = id || fn.id || fn.name || 'unknown';\n\t\tthis.id = uid( this.name );\n\t}\n\n\tready () {\n\t\tlet observation;\n\n\t\tif ( !this._ready ) {\n\t\t\tobservation = {\n\t\t\t\tnode: this,\n\t\t\t\tlog: makeLog( this ),\n\t\t\t\tenv: config.env,\n\t\t\t\tsander: sander\n\t\t\t};\n\n\t\t\tthis._abort = () => {\n\t\t\t\tthis._ready = null;\n\t\t\t\tobservation.aborted = true;\n\t\t\t};\n\n\t\t\tthis._ready = this.input.ready().then( inputdir => {\n\t\t\t\treturn queue.add( ( fulfil, reject ) => {\n\t\t\t\t\tthis.emit( 'info', {\n\t\t\t\t\t\tcode: 'TRANSFORM_START', // TODO\n\t\t\t\t\t\tprogressIndicator: true,\n\t\t\t\t\t\tid: this.id\n\t\t\t\t\t});\n\n\t\t\t\t\tconst start = Date.now();\n\t\t\t\t\tlet called = false;\n\n\t\t\t\t\tconst callback = err => {\n\t\t\t\t\t\tif ( called ) return;\n\t\t\t\t\t\tcalled = true;\n\n\t\t\t\t\t\tif ( observation.aborted ) {\n\t\t\t\t\t\t\treject( ABORTED );\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\telse if ( err ) {\n\t\t\t\t\t\t\tlet stack = err.stack || new Error().stack;\n\t\t\t\t\t\t\tlet { file, line, column } = extractLocationInfo( err );\n\n\t\t\t\t\t\t\tlet gobbleError = new GobbleError({\n\t\t\t\t\t\t\t\tinputdir,\n\t\t\t\t\t\t\t\tstack, file, line, column,\n\t\t\t\t\t\t\t\tmessage: 'observation failed',\n\t\t\t\t\t\t\t\tid: this.id,\n\t\t\t\t\t\t\t\tcode: 'TRANSFORMATION_FAILED', // TODO\n\t\t\t\t\t\t\t\toriginal: err\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\treject( gobbleError );\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tthis.emit( 'info', {\n\t\t\t\t\t\t\t\tcode: 'TRANSFORM_COMPLETE', // TODO\n\t\t\t\t\t\t\t\tid: this.id,\n\t\t\t\t\t\t\t\tduration: Date.now() - start\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tfulfil( inputdir );\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tobservation.changes = this.input.changes || this.getChanges( inputdir );\n\n\t\t\t\t\t\tconst promise = this.fn.call( observation, inputdir, assign({}, this.options ), callback );\n\t\t\t\t\t\tconst promiseIsPromise = promise && typeof promise.then === 'function';\n\n\t\t\t\t\t\tif ( !promiseIsPromise && this.fn.length < 3 ) {\n\t\t\t\t\t\t\tthrow new Error( `Observer ${this.id} did not return a promise and did not accept callback` );\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif ( promiseIsPromise ) {\n\t\t\t\t\t\t\tpromise.then( () => callback(), callback );\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch ( err ) {\n\t\t\t\t\t\tcallback( err );\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\treturn this._ready;\n\t}\n\n\tstart () {\n\t\tif ( this._active ) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._active = true;\n\n\t\t// Propagate invalidation events and information\n\t\tthis._oninvalidate = changes => {\n\t\t\tthis._abort();\n\t\t\tthis.emit( 'invalidate', changes );\n\t\t};\n\n\t\tthis._oninfo = details => this.emit( 'info', details );\n\n\t\tthis.input.on( 'invalidate', this._oninvalidate );\n\t\tthis.input.on( 'info', this._oninfo );\n\n\t\treturn this.input.start();\n\t}\n\n\tstop () {\n\t\tthis.input.off( 'invalidate', this._oninvalidate );\n\t\tthis.input.off( 'info', this._oninfo );\n\n\t\tthis.input.stop();\n\t\tthis._active = false;\n\t}\n\n\tactive () {\n\t\treturn this._active;\n\t}\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;AAIA,IAAA,kBAA+B,UAA/B,UAAA,aAAA,EAAA,IAAA,EAAA,oBAAA,cAAA,EAAA,MAAA,IAAA,UAAA;;AAWG,IAAH,WAAA,CAAA,UAA6B,OAA7B;AACI,CAAJ,SAAW,SAAX,OAAA,IAAA,SAA0C,IAA1C;AACK,EAAL,gBAAA,MAAyB;;AAEzB,EAAA,MAAA,KAAA;;AAEG,EAAH,KAAA,QAAA;;;AAGC,EAAD,KAAA,2BAAA,CAAA,IAA+B;;AAE7B,EAAF,KAAA,OAAgB,MAAhB,GAAA,MAAA,GAAA,QAAA;AACG,EAAH,KAAQ,mBAAR,CAAiB,KAAjB;AACI;;AAEJ,CAAA,UAAA,UAAA;;AAEE,CAAF,SAAA,UAAA,QAAA,SAAA,QAAA;AACA,EAAE,IAAF,QAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}