{"version":3,"file":"Source.js","sources":["../../../../src/nodes/Source.js"],"sourcesContent":["import { basename, relative, resolve } from 'path';\nimport { link, linkSync, mkdirSync, statSync, Promise } from 'sander';\nimport { watch } from 'graceful-chokidar';\nimport * as debounce from 'debounce';\nimport Node from './Node';\nimport uid from '../utils/uid';\nimport session from '../session';\nimport GobbleError from '../utils/GobbleError';\n\nexport default class Source extends Node {\n\tconstructor ( dir, options = {} ) {\n\t\tsuper();\n\n\t\tthis.id = options.id || 'source';\n\t\tthis.dir = dir;\n\t\tthis.callbacks = [];\n\n\t\t// Ensure the source exists, and is a directory\n\t\ttry {\n\t\t\tconst stats = statSync( this.dir );\n\n\t\t\tif ( !stats.isDirectory() ) {\n\t\t\t\tthis.file = dir;\n\t\t\t\tthis.dir = undefined;\n\n\t\t\t\tthis.uid = uid( this.id );\n\n\t\t\t\tthis._ready = new Promise( ( ok, fail ) => {\n\t\t\t\t\tthis._deferred = { ok, fail };\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthis._ready = Promise.resolve( this.dir );\n\t\t\t}\n\t\t} catch ( err ) {\n\t\t\tif ( err.code === 'ENOENT' ) {\n\t\t\t\tthrow new GobbleError({\n\t\t\t\t\tcode: 'MISSING_DIRECTORY',\n\t\t\t\t\tpath: dir,\n\t\t\t\t\tmessage: `the ${dir} directory does not exist`\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthrow err;\n\t\t}\n\n\t\tthis.static = options && options.static;\n\t}\n\n\tready () {\n\t\treturn this._ready;\n\t}\n\n\tstart () {\n\t\tif ( this._active || this.static ) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._active = true;\n\n\t\t// this is a file watch that isn't fully initialized\n\t\tif ( this._deferred ) {\n\t\t\tthis._makeReady();\n\t\t}\n\n\t\t// make sure the file is in the appropriate target directory to start\n\t\tif ( this.file ) {\n\t\t\tlinkSync( this.file ).to( this.targetFile );\n\t\t}\n\n\t\tlet changes = [];\n\n\t\tconst relay = debounce( () => {\n\t\t\tthis.changes = changes.map( change => {\n\t\t\t\tconst result = {\n\t\t\t\t\tfile: relative( this.dir, change.path )\n\t\t\t\t};\n\n\t\t\t\tchange.type === 'add'    && ( change.added = true );\n\t\t\t\tchange.type === 'change' && ( change.changed = true );\n\t\t\t\tchange.type === 'unlink' && ( change.removed = true );\n\n\t\t\t\treturn result;\n\t\t\t});\n\n\t\t\tthis.emit( 'invalidate', changes );\n\t\t\tchanges = [];\n\t\t}, 100 );\n\n\t\tconst options = {\n\t\t\tpersistent: true,\n\t\t\tignoreInitial: true,\n\t\t\tuseFsEvents: false // see https://github.com/paulmillr/chokidar/issues/146\n\t\t};\n\n\t\tthis._watcher = watch( this.dir, options );\n\n\t\t[ 'add', 'change', 'unlink' ].forEach( type => {\n\t\t\tthis._watcher.on( type, path => {\n\t\t\t\tchanges.push({ type, path });\n\t\t\t\trelay();\n\t\t\t});\n\t\t});\n\n\t\tif ( this.file ) {\n\t\t\tthis._fileWatcher = watch( this.file, options );\n\n\t\t\tthis._fileWatcher.on( 'change', () => {\n\t\t\t\tlink( this.file ).to( this.targetFile );\n\t\t\t});\n\t\t}\n\t}\n\n\tstop () {\n\t\tif ( this._watcher ) {\n\t\t\tthis._watcher.close();\n\t\t}\n\n\t\tif ( this._fileWatcher ) {\n\t\t\tthis._fileWatcher.close();\n\t\t}\n\n\t\tthis._active = false;\n\t}\n\n\tactive () {\n\t\treturn this._active;\n\t}\n\n\t_findCreator ( filename ) {\n\t\ttry {\n\t\t\tstatSync( filename );\n\t\t\treturn this;\n\t\t} catch ( err ) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t_makeReady () {\n\t\tthis.dir = resolve( session.config.gobbledir, this.uid );\n\t\tthis.targetFile = resolve( this.dir, basename( this.file ) );\n\n\t\ttry {\n\t\t\tmkdirSync( this.dir );\n\t\t\tthis._deferred.ok( this.dir );\n\t\t} catch (e) {\n\t\t\tthis._deferred.fail( e );\n\t\t\tthrow e;\n\t\t}\n\n\t\tdelete this._deferred;\n\t}\n}\n"],"names":[],"mappings":"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"}