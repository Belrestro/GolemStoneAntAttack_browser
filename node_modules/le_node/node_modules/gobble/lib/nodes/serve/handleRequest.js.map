{"version":3,"file":"handleRequest.js","sources":["../../../../../../src/nodes/serve/handleRequest.js"],"sourcesContent":["import { extname, join } from 'path';\nimport { parse } from 'url';\nimport { stat, Promise } from 'sander';\nimport serveFile from './serveFile';\nimport serveDir from './serveDir';\nimport serveSourcemap from './serveSourcemap';\nimport serveError from './serveError';\n\nexport default function handleRequest ( srcDir, error, sourcemapPromises, request, response ) {\n\tconst parsedUrl = parse( request.url );\n\tconst pathname = parsedUrl.pathname;\n\n\tlet filepath;\n\n\tif ( error ) {\n\t\tif ( pathname.substr( 0, 11 ) === '/__gobble__' ) {\n\t\t\tconst message = ( error.original && error.original.message ) || error.message || '';\n\t\t\tfilepath = pathname.substring( 11 );\n\n\t\t\t// only allow links to files that we're actually interested in, not\n\t\t\t// the whole damn filesystem\n\t\t\tif ( ~message.indexOf( filepath ) || ~error.stack.indexOf( filepath ) ) {\n\t\t\t\treturn serveFile( pathname.substring( 11 ), request, response );\n\t\t\t}\n\t\t}\n\n\t\tserveError( error, request, response );\n\t\treturn Promise.resolve();\n\t}\n\n\tfilepath = join( srcDir, pathname );\n\n\tif ( extname( filepath ) === '.map' ) {\n\t\treturn serveSourcemap( filepath, sourcemapPromises, request, response )\n\t\t\t.catch( err => serveError( err, request, response ) );\n\t}\n\n\treturn stat( filepath ).then( stats => {\n\t\tif ( stats.isDirectory() ) {\n\t\t\t// might need to redirect from `foo` to `foo/`\n\t\t\tif ( pathname.slice( -1 ) !== '/' ) {\n\t\t\t\tresponse.setHeader( 'Location', pathname + '/' + ( parsedUrl.search || '' ) );\n\t\t\t\tresponse.writeHead( 301 );\n\n\t\t\t\tresponse.end();\n\t\t\t} else {\n\t\t\t\treturn serveDir( filepath, request, response );\n\t\t\t}\n\t\t}\n\n\t\telse {\n\t\t\treturn serveFile( filepath, request, response );\n\t\t}\n\t}, err => serveError( err, request, response ) );\n}\n"],"names":[],"mappings":";;;;;;;;;;;;qBAQwB;AAAT,SAAS,cAAgB,QAAQ,OAAO,mBAAmB,SAAS,UAAW;AAC7F,CAAD,IAAO,qBAAiB,CAAE,QAAQ;AACjC,CAAD,IAAO,WAAW,UAAU;;AAE3B,CAAD,IAAK,WAAL;;AAEC,CAAD,IAAM,OAAQ;AACZ,EAAF,IAAO,SAAS,OAAQ,GAAG,QAAS,eAAgB;AACjD,GAAH,IAAS,UAAU,MAAQ,YAAY,MAAM,SAAS,WAAa,MAAM,WAAW;AACjF,GAAH,WAAc,SAAS,UAAW;;;;AAI/B,GAAH,IAAQ,CAAC,QAAQ,QAAS,aAAc,CAAC,MAAM,MAAM,QAAS,WAAa;AACvE,IAAJ,2BAAoB,CAAE,SAAS,UAAW,KAAM,SAAS;AACzD;AACA;;AAEE,uBAAU,CAAE,OAAO,SAAS;AAC5B,EAAF,qBAAgB,CAAC;AACjB;;AAEC,CAAD,oBAAgB,CAAE,QAAQ;;AAEzB,CAAD,gBAAa,CAAE,cAAe,QAAS;AACrC,EAAF,gCAAuB,CAAE,UAAU,mBAAmB,SAAS,UAA/D,SACW,UAAA,KADX;AACA,GAAA,4BAA4B,CAAE,KAAK,SAAS;AAA5C;AACA;;AAEC,CAAD,kBAAY,CAAE,UAAW,KAAM,UAAA,OAAS;AACtC,EAAF,IAAO,MAAM,eAAgB;;AAE1B,GAAH,IAAQ,SAAS,MAAO,CAAC,OAAQ,KAAM;AACnC,IAAJ,SAAa,UAAW,YAAY,WAAW,OAAQ,UAAU,UAAU;AACvE,IAAJ,SAAa,UAAW;;AAEpB,IAAJ,SAAa;AACb,UAAU;AACN,IAAJ,0BAAmB,CAAE,UAAU,SAAS;AACxC;AACA,SAEO;AACJ,GAAH,2BAAmB,CAAE,UAAU,SAAS;AACxC;AACA,IAAI,UAAA,KAAJ;AAAA,EAAA,4BAAqB,CAAE,KAAK,SAAS;AAArC;AACA"}